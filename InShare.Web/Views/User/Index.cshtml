@model InShare.Model.UserEntity

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutHome.cshtml";
}

@section head {
    <style type="text/css">
        .head {
            height: 90px;
            text-align: center;
            color: gray;
            font-size: 30px;
        }

            .head span {
                float: left;
                margin-left: 195px;
                margin-top: 50px;
            }

        .headRight {
            float: right;
            top: 50px;
            right: 210px;
            position: relative;
        }

            .headRight a {
                color: #FF8585;
                font-size: 15px;
            }

                .headRight a:hover {
                    text-decoration: none;
                    color: #ec2b58
                }

        .myIndex {
            margin: 140px auto;
            width: 100%;
            height: 100%;
        }

        .center {
            height: 150px;
            /*background: url(image/21.jpg);*/
        }

            .center .centerTop {
                /*width: 1200px;*/
                height: 100%;
            }

                .center .centerTop img {
                    /*margin-right: 30px;*/
                }

                .center .centerTop .top1 {
                    /*width: 1000px;*/
                }

        .top1 .top1Left {
            margin: 0px auto;
            width: 400px;
            height: 150px;
        }

            .top1 .top1Left a {
            }

        .top1Left ul li {
            float: left;
            margin-right: 30px;
            margin-top: 5px;
        }

        .center .centerTop .top2 {
            /*width: 1000px;*/
            height: 50px;
            margin-top: 40px;
        }

        .top2 ul li {
            float: left;
            margin-top: 10px;
            margin-left: 220px;
            font-size: 20px;
            list-style: none;
        }

        .top2 b {
            color: black;
            margin-left: 200px;
            list-style: none;
        }

        .center .centerOther {
            margin-top: 10px;
            /*width: 1200px;*/
            border: solid 1px red;
        }


        .t1, .t2, .t3, .t4, .t5, .t6, .t7 {
            width: 400px;
            height: 38px;
            margin: 0px auto;
            margin-top: 4px;
            position: relative;
            border: 1px solid #ddd;
        }

        #main {
            margin-top: -5em;
        }

        #tiles li {
            width: 350px;
            height: 310px;
            float: left;
            margin: 10px 25px;
        }

            #tiles li img {
                height: 100%;
            }
    </style>
}

<div class="myIndex">
    <div class="center">
        <div class="centerTop">
            <div class="top1">
                <div style="position: absolute;height:150px;width:150px;margin-left:250px;">
                    <img id="profilePic" src="@Model.ProfilePic" />
                </div>
                <div class="top1Left">
                    <text style="font-size:xx-large;" id="user-name">@Model.UserName</text>
                    @if (Model.Id == Convert.ToInt64(Session["userId"]))
                    {
                        <button type="button" style="position: relative; float: right; font-size: x-large; margin-top: 5px;" id="btn_edit">edit profile</button>
                    }
                    else
                    {
                        if (ViewBag.Following)
                        {
                            <button type="button" style="position: relative; float: right; font-size: x-large; margin-top: 5px;" onclick="handleClick(this)">Following</button>
                            <input type="hidden" value="1" id="followValue" />
                        }
                        else
                        {
                            <button type="button" style="position: relative; float: right; font-size: x-large; margin-top: 5px;" onclick="handleClick(this)">Follow</button>
                            <input type="hidden" value="0" id="followValue" />
                        }
                    }
                    <ul style="width: 100%; height: 30px; padding: 10px 0px;">
                        <li>following <span id="following-count">@ViewBag.FollowingCount</span> </li>
                        <li>follower <span id="follower-count">@ViewBag.FollowerCount </span></li>
                        <li>posts <span id="post-count">@ViewBag.PostCount</span></li>
                        <input type="hidden" value="@ViewBag.PostCount" id="postCount" />
                    </ul>
                    <ul>
                        <li><span id="full-name">@Model.FullName</span> | <span id="biography">@Model.Biography</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" value="1" id="pageIndex" />
<!---start-content---->
<div class="content">
    <div class="wrap">
        <div id="main" role="main">
            <ul id="tiles">
                <!-- These are our grid blocks -->
                @foreach (var post in ViewBag.PostList)
                {
                <li onclick="location.href='/Post/@post.ShortCode';">
                    <img src="@post.DisplayUrl">
                </li>
                }
                <!-- End of grid blocks -->
            </ul>
        </div>
    </div>
</div>
<!---//End-content---->

@section script {
    <!----wookmark-scripts---->
    <script src="~/Content/js/jquery.imagesloaded.js"></script>
    <script src="~/Content/js/jquery.wookmark.js"></script>
    <script type="text/javascript">
        var isLoading = false;
        (function ($) {
            var $tiles = $('#tiles'),
                $handler = $('li', $tiles),
                $main = $('#main'),
                $window = $(window),
                $document = $(document),
                options = {
                    autoResize: true, // This will auto-update the layout when the browser window is resized.
                    container: $main, // Optional, used for some extra CSS styling
                    offset: 20, // Optional, the distance between grid items
                    itemWidth: 280 // Optional, the width of a grid item
                };
            /**
             * Reinitializes the wookmark handler after all images have loaded
             */
            function applyLayout() {
                $tiles.imagesLoaded(function () {
                    // Destroy the old handler
                    if ($handler.wookmarkInstance) {
                        $handler.wookmarkInstance.clear();
                    }
                    // Create a new layout handler.
                    $handler = $('li', $tiles);
                    $handler.wookmark(options);
                });
            }
            /**
             * When scrolled all the way to the bottom, add more tiles
             */
            function onScroll() {
                // Check if we're within 100 pixels of the bottom edge of the broser window.
                //var winHeight = window.innerHeight ? window.innerHeight : $window.height(), // iphone fix
                //    //$window.scrollTop() 滚动条距顶部距离(页面超出窗口的高度)
                //    closeToBottom = ($window.scrollTop() + winHeight > $document.height() - 200);

                if ($(document).scrollTop() >= $(document).height() - $(window).height()) {
                    var pageIndex = $("#pageIndex").val();
                    var userId = parseInt(window.location.pathname.replace(/[^0-9]/ig, ""));
                    var postCount = $("#postCount").val();
                    if (pageIndex * 6 >= postCount) {
                        return;//防止已全部加载后继续发送请求
                    }
                    var loadedCount = $("#tiles").children("li").length;
                    if ((pageIndex - 1) * 6 == loadedCount) {
                        return;//防止重复加载
                    }
                    if (isLoading) {
                        return;
                    }
                    isLoading = true;
                    //发送加载下一页请求
                    $.ajax({
                        url: "/User/Load", dataType: "json",
                        type: "post", data: { userId: userId, pageIndex: ++pageIndex },
                        success: function (res) {
                            if (res.Status == "OK") {
                                $("#pageIndex").val(pageIndex);
                                for (var i = 0; i < res.Data.length; i++) {
                                    var postUrl = "location.href='/Post/" + res.Data[i].ShortCode + "';";
                                    $tiles.append('<li onclick="' + postUrl + '"><img src="' + res.Data[i].DisplayUrl + '"></li>');
                                }
                                isLoading = false;
                            } else {

                            }
                        }, error: function () {

                        }
                    });
                    applyLayout();
                }
            };

            // Call the layout function for the first time
            applyLayout();

            // Capture scroll event.
            $window.bind('scroll.wookmark', onScroll);
        })(jQuery);

        $(document).ready(function () {
            $(window).scroll(function () {
                //$(document).scrollTop() 获取垂直滚动的距离
                //$(document).scrollLeft() 这是获取水平滚动条的距离
                //if ($(document).scrollTop() <= 0) {
                //    alert("滚动条已经到达顶部为0");
                //}
                if ($(document).scrollTop() >= $(document).height() - $(window).height()) {
                    //alert("滚动条已经到达底部为" + $(document).scrollTop());
                }
            });
        });
    </script>
    <!----//wookmark-scripts---->

    <script>
        var userId = parseInt(window.location.pathname.replace(/[^0-9]/ig, ""));
        $(function () {

        });
        //按钮点击
        function handleClick(ev) {
            var isFollow = $("#followValue").val();
            if (isFollow == 1) {
                $.post("/User/Unfollow", { userId, userId },
                    function (res) {
                        if (res.Status == "OK") {
                            $("#followValue").val("0");
                            ev.textContent = "Follow";
                            loadUserInfo();
                        }
                        if (res.Status == "Error") {
                            alert(res.ErrorMsg);
                        }
                    });
            }
            else {
                $.post("/User/Follow", { userId, userId },
                    function (res) {
                        if (res.Status == "OK") {
                            $("#followValue").val("1")
                            ev.textContent = "Following";
                            loadUserInfo();
                        }
                        if (res.Status == "Error") {
                            alert(res.ErrorMsg);
                        }
                    });
            }
        }
        //加载用户信息
        function loadUserInfo() {
            $.post("/User/LoadUserInfo", { userId, userId },
                function (res) {
                    if (res.Status == "OK") {
                        $("#user-name")[0].innerText = res.Data.UserName;
                        $("#full-name")[0].innerText = res.Data.FullName;
                        $("#profilePic")[0].innerText = res.Data.ProfilePic;
                        $("#biography")[0].innerText = res.Data.Biography;
                        $("#following-count")[0].innerText = res.Data.FollowingCount;
                        $("#follower-count")[0].innerText = res.Data.FollowerCount;
                        $("#post-count")[0].innerText = res.Data.PostCount;
                    }
                });
        }
    </script>

}
